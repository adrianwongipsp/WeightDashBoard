<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <title>Dashboard Incrementos de Mega Zona California</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      background: #0e1a3a;
      color: white;
      font-family: 'Segoe UI', sans-serif;
      padding: 20px;
    }

    h1 {
      text-align: center;
      color: #00cfff;
      font-size: 2.2em;
      text-shadow: 1px 1px 4px #003d66;
      margin-bottom: 10px;
    }

    h2 {
      text-align: center;
      color: #00cfff;
      font-size: 1.4em;
      margin-bottom: 10px;
    }

    .charts-wrapper {
      display: flex;
      flex-direction: row;
      justify-content: space-between;
      gap: 30px;
      margin-top: 30px;
    }

    .chart-container {
      flex: 1;
      background: #13254d;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      padding: 10px 10px 20px;
    }

    svg {
      background: transparent;
      display: block;
      margin: auto;
      width: 100%;
      height: 450px;
    }

    .tick text {
      fill: #e0e0e0;
      font-size: 12px;
    }

    .domain,
    .tick line {
      stroke: #00cfff;
    }

    .tooltip {
      position: absolute;
      background: #00cfff;
      color: #0e1a3a;
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 13px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    /* === POPUP STYLES === */
    .popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .popup-content {
      background: #13254d;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
      width: 80%;
      max-width: 900px;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
      from {
        transform: translateY(-20px);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .popup-header {
      background: #13254d;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 2;
      border-bottom: 1px solid #00cfff;
    }

    .popup-header h2 {
      margin: 0;
      font-size: 1.4em;
      color: #00cfff;
    }

    .popup-close {
      font-size: 28px;
      font-weight: bold;
      color: #fff;
      cursor: pointer;
    }

    .popup-body {
      padding: 20px;
      overflow-y: auto;
    }

    .popup-body table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    .popup-body th,
    .popup-body td {
      border: 1px solid #00cfff;
      padding: 8px;
      text-align: left;
    }

    .popup-body th {
      background-color: #00cfff;
      color: #0e1a3a;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .popup-body tr:hover {
      background-color: #1f3a6b;
    }

    /* === SLIDER STYLES === */
    .slider-container {
      position: relative;
      width: 100%;
      overflow: hidden;
      margin-top: 30px;
    }

    .slider-wrapper {
      display: flex;
      transition: transform 0.5s ease-in-out;
    }

    .slide {
      min-width: 100%;
      box-sizing: border-box;
    }

    .slider-button {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background-color: rgba(0, 207, 255, 0.5);
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      padding: 10px;
      z-index: 100;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .slider-button.prev {
      left: 10px;
    }

    .slider-button.next {
      right: 10px;
    }

    .pagination-dots {
      text-align: center;
      position: absolute;
      bottom: 10px;
      width: 100%;
    }

    .dot {
      cursor: pointer;
      height: 15px;
      width: 15px;
      margin: 0 5px;
      background-color: #bbb;
      border-radius: 50%;
      display: inline-block;
      transition: background-color 0.6s ease;
    }

    .dot.active {
      background-color: #00cfff;
    }
  </style>
</head>

<body>

  <h1>DASHBOARD MEGA ZONA CALIFORNIA</h1>

  <div class="slider-container">
    <div class="slider-wrapper">
      <div class="slide">
        <div class="charts-wrapper">
          <div class="chart-container">
            <h2 id="tituloBarChart">Incrementos por Sector de la Semana Actual</h2>
            <svg id="incrementBarChart"></svg>
          </div>
          <div class="chart-container">
            <h2>Evolución de Métricas en las Últimas 4 Semanas</h2>
            <svg id="lineChart"></svg>
          </div>
        </div>
      </div>
      <div class="slide">
        <div class="charts-wrapper">
          <div class="chart-container">
            <h2>Total de Cantidad de Muestreos por Sector</h2>
            <svg id="barChart"></svg>
          </div>
        </div>
      </div>
    </div>
    <button class="slider-button prev">&#10094;</button>
    <button class="slider-button next">&#10095;</button>
    <div class="pagination-dots"></div>
  </div>

  <div class="tooltip" id="tooltip"></div>


  <div class="popup-overlay" id="popup">
    <div class="popup-content">
      <div class="popup-header">
        <h2 id="popup-title">Detalles del Sector</h2>
        <span class="popup-close" id="popup-close">&times;</span>
      </div>
      <div id="popup-table-container" class="popup-body"></div>
    </div>
  </div>


  <script>
    const tooltip = d3.select("#tooltip");

    function renderBarChart(data) {
      const sortedData = [...data].sort((a, b) => b.TotalIncremento - a.TotalIncremento);

      const svg = d3.select("#barChart");
      svg.selectAll("*").remove();

      const containerWidth = svg.node().clientWidth;
      const margin = { top: 20, right: 30, bottom: 40, left: 140 };
      const width = containerWidth - margin.left - margin.right;
      const height = 450 - margin.top - margin.bottom;
      const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

      const y = d3.scaleBand()
        .domain(sortedData.map(d => d.Sector))
        .range([0, height])
        .padding(0.3);

      const x = d3.scaleLinear()
        .domain([0, d3.max(sortedData, d => d.TotalIncremento)])
        .range([0, width]);

      const colorScale = d3.scaleLinear()
        .domain([d3.min(sortedData, d => d.TotalIncremento), d3.max(sortedData, d => d.TotalIncremento)])
        .range(["#a2d4f5", "#007acc"]);

      g.append("g")
        .call(d3.axisLeft(y).tickSize(0))
        .selectAll("text")
        .style("font-size", "13px")
        .style("fill", "#ffffff");

      g.append("g")
        .attr("transform", `translate(0,${height})`)
        .call(d3.axisBottom(x).ticks(5).tickSize(0))
        .selectAll("text")
        .style("font-size", "12px")
        .style("fill", "#ffffff");

      // Crear barras y guardar referencia
      const bars = g.selectAll(".bar")
        .data(sortedData)
        .enter()
        .append("rect")
        .attr("class", "bar")
        .attr("y", d => y(d.Sector))
        .attr("height", y.bandwidth())
        .attr("x", 0)
        .attr("width", 0)
        .attr("rx", 6)
        .attr("fill", d => colorScale(d.TotalIncremento))
        .style("cursor", "pointer")
        .on("mouseover", (event, d) => {
          tooltip.style("left", `${event.pageX + 10}px`)
            .style("top", `${event.pageY - 20}px`)
            .style("opacity", 1)
            .html(`<strong>${d.Sector}</strong><br>Total de Muestreos: ${d.TotalIncremento}`);
        })
        .on("mouseout", () => tooltip.style("opacity", 0))
      // .on("click", async (event, d) => {
      //   // const popup = document.getElementById('popup');
      //   // const popupTitle = document.getElementById('popup-title');

      //   // popupTitle.textContent = `Detalles del Sector: ${d.Sector}`;
      //   // renderizarTablaPopup(null);
      //   // popup.style.display = 'flex';
      //   try {
      //     //const detalles = await obtenerDetallesPiscina(d.IdSector);
      //     //renderizarTablaPopup(detalles);
      //   } catch (error) {
      //     console.error("Error al obtener detalles:", error);
      //   }
      // });

      // Animación separada
      bars.transition()
        .duration(800)
        .attr("width", d => x(d.TotalIncremento));
    }

    function renderIncrementBarChart(data) {
      const svg = d3.select("#incrementBarChart");
      svg.selectAll("*").remove();

      const containerWidth = svg.node().clientWidth || 900;
      const margin = { top: 30, right: 30, bottom: 80, left: 60 };
      const width = containerWidth - margin.left - margin.right;
      const height = 450 - margin.top - margin.bottom;

      const g = svg
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`);

      const processed = data
        .map(d => ({
          Sector: d.Sector,
          Total: Math.floor((d.IncSemanal) * 100) / 100,
          IdSector: d.IdSector,
          Semana: d.Semana,
        }))
        .sort((a, b) => a.Total - b.Total);

      const x = d3.scaleBand()
        .domain(processed.map(d => d.Sector))
        .range([0, width])
        .padding(0);

      const y = d3.scaleLinear()
        .domain([0, d3.max(processed, d => d.Total)])
        .range([height, 0]);

      const colorScale = d3.scaleLinear()
        .domain([0, d3.max(processed, d => d.Total)])
        .range(["#ffd699", "#ff6600"]);

      const xAxis = g.append("g")
        .attr("transform", `translate(0,${height})`)
        .call(d3.axisBottom(x).tickSize(0));

      xAxis.selectAll("text")
        .attr("transform", "rotate(-45)")
        .style("text-anchor", "end")
        .style("font-size", "12px")
        .style("fill", "#ffffff");

      xAxis.select(".domain").remove();

      const yAxis = g.append("g")
        .call(d3.axisLeft(y).ticks(0).tickSize(0));

      yAxis.selectAll("text").remove();
      yAxis.select(".domain").remove();

      const tooltip = d3.select("body").append("div")
        .attr("class", "tooltip")
        .style("position", "absolute")
        .style("padding", "6px 10px")
        .style("background", "#333")
        .style("color", "#fff")
        .style("border-radius", "4px")
        .style("font-size", "12px")
        .style("pointer-events", "none")
        .style("opacity", 0);

      const bars = g.selectAll("rect")
        .data(processed)
        .enter()
        .append("rect")
        .attr("x", d => x(d.Sector))
        .attr("y", height) // animación: empieza desde abajo
        .attr("width", x.bandwidth())
        .attr("height", 0)
        .attr("fill", d => colorScale(d.Total))
        .attr("rx", 4)
        .style("cursor", "pointer")
        .on("mouseover", (event, d) => {
          tooltip.style("left", `${event.pageX + 10}px`)
            .style("top", `${event.pageY - 20}px`)
            .style("opacity", 1)
            .html(`<strong>${d.Sector}</strong><br>Total Incremento: ${d.Total.toFixed(2)}`);
        })
        .on("mouseout", () => tooltip.style("opacity", 0))
        .on("click", async (event, d) => {
          const popup = document.getElementById('popup');
          const popupTitle = document.getElementById('popup-title');
          const closeBtn = document.getElementById('popup-close');

          popupTitle.textContent = `Detalles del Sector: ${d.Sector}`;
          renderizarTablaPopup(null);
          popup.style.display = 'flex';

          try {
            const detalles = await obtenerDetallesPiscina(d.IdSector, d.Semana);
            renderizarTablaPopup(detalles);
          } catch (error) {
            console.error("Error al obtener detalles:", error);
          }

          closeBtn.onclick = () => {
            popup.style.display = 'none';
          };
        });

      // Animación de subida
      bars.transition()
        .duration(800)
        .attr("y", d => y(d.Total))
        .attr("height", d => height - y(d.Total));

      // Etiquetas de valor
      g.selectAll("text.value")
        .data(processed)
        .enter()
        .append("text")
        .attr("class", "value")
        .attr("x", d => x(d.Sector) + x.bandwidth() / 2)
        .attr("y", d => y(d.Total) - 5)
        .attr("text-anchor", "middle")
        .style("fill", "#ffffff")
        .style("font-size", "11px")
        .text(d => d.Total.toFixed(2));
    }

    function renderLineChart(datosValidados) {
      const svg = d3.select("#lineChart");
      svg.selectAll("*").remove();

      const containerWidth = svg.node().clientWidth || 600;
      const margin = { top: 40, right: 40, bottom: 120, left: 60 };
      const width = containerWidth - margin.left - margin.right;
      const height = 450 - margin.top - margin.bottom;

      const g = svg
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom + 60)
        .append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`);

      const tooltip = d3.select("body").append("div")
        .attr("class", "tooltip")
        .style("position", "absolute")
        .style("padding", "6px 10px")
        .style("background", "#333")
        .style("color", "#fff")
        .style("border-radius", "4px")
        .style("font-size", "12px")
        .style("pointer-events", "none")
        .style("opacity", 0);

      const rawSeries = [];
      datosValidados.forEach(d => {
        const baseSemana = d.Semana ?? 0;
        const sector = d.Sector ?? '';
        const idSector = d.IdSector ?? null;
        rawSeries.push(
          { Sector: sector, Semana: baseSemana - 4, Incremento: d.IncrementoSemana1 ?? 0, IdSector: idSector },
          { Sector: sector, Semana: baseSemana - 3, Incremento: d.IncrementoSemana2 ?? 0, IdSector: idSector },
          { Sector: sector, Semana: baseSemana - 2, Incremento: d.IncrementoSemana3 ?? 0, IdSector: idSector },
          { Sector: sector, Semana: baseSemana - 1, Incremento: d.IncrementoSemana4 ?? 0, IdSector: idSector }
        );
      });

      const grouped = d3.group(rawSeries, d => d.Sector);
      const series = Array.from(grouped, ([sector, values]) => {
        const uniqueByWeek = Array.from(
          d3.group(values, d => d.Semana),
          ([semana, entries]) => entries[0]
        );
        return { Sector: sector, values: uniqueByWeek.sort((a, b) => a.Semana - b.Semana) };
      });

      const allWeeks = [...new Set(series.flatMap(s => s.values.map(v => v.Semana)))].sort((a, b) => a - b);
      const allValues = series.flatMap(s => s.values.map(v => v.Incremento));

      const x = d3.scalePoint()
        .domain(allWeeks)
        .range([0, width])
        .padding(0.2);

      const y = d3.scaleLinear()
        .domain([1, d3.max(allValues)])
        .range([height, 0]);

      const color = d3.scaleOrdinal(d3.schemeCategory10);

      const xAxis = g.append("g")
        .attr("transform", `translate(0,${height})`)
        .call(d3.axisBottom(x).tickFormat(d => `Semana ${d}`).tickSize(0));

      xAxis.selectAll("text")
        .attr("transform", "rotate(-45)")
        .style("text-anchor", "end")
        .style("font-size", "12px")
        .style("fill", "#ffffff");

      xAxis.select(".domain").attr("stroke", "#ffffff");
      xAxis.selectAll(".tick line").remove();

      const yAxis = g.append("g")
        .call(d3.axisLeft(y).ticks(5).tickFormat(d => d === 0 ? "" : d));

      yAxis.selectAll(".tick line").remove();
      yAxis.selectAll("text")
        .style("font-size", "12px")
        .style("fill", "#ffffff");

      yAxis.select(".domain")
        .attr("stroke", "#ffffff")
        .attr("stroke-width", 1.5);

      const line = d3.line()
        .x(d => x(d.Semana))
        .y(d => y(d.Incremento));

      series.forEach((s, i) => {
        g.append("path")
          .datum(s.values)
          .attr("fill", "none")
          .attr("stroke", color(s.Sector))
          .attr("stroke-width", 3)
          .attr("d", line);

        g.selectAll(`circle.sector-${i}`)
          .data(s.values)
          .enter()
          .append("circle")
          .attr("class", `sector-${i}`)
          .attr("cx", d => x(d.Semana))
          .attr("cy", d => y(d.Incremento))
          .attr("r", 3)
          .attr("fill", color(s.Sector))
          .style("cursor", "pointer")
          .on("mouseover", (event, d) => {
            tooltip.style("left", `${event.pageX + 10}px`)
              .style("top", `${event.pageY - 20}px`)
              .style("opacity", 1)
              .html(`<strong>${d.Sector}</strong><br>Semana ${d.Semana}<br>Incremento: ${d.Incremento.toFixed(2)}`);
          })
          .on("mouseout", () => tooltip.style("opacity", 0))
          .on("click", async (event, d) => {
            const popup = document.getElementById('popup');
            const popupTitle = document.getElementById('popup-title');
            const closeBtn = document.getElementById('popup-close');

            popupTitle.textContent = `Detalles del Sector: ${d.Sector} (Semana ${d.Semana})`;
            renderizarTablaPopup(null);
            popup.style.display = 'flex';

            try {
              const detalles = await obtenerDetallesPiscina(d.IdSector, d.Semana);
              renderizarTablaPopup(detalles);
            } catch (error) {
              console.error("Error al obtener detalles:", error);
            }

            closeBtn.onclick = () => {
              popup.style.display = 'none';
            };
          });
      });

      const legend = svg.append("g")
        .attr("transform", `translate(${margin.left},${height + margin.top + 60})`);

      const itemsPerRow = 3;
      series.forEach((s, i) => {
        const col = i % itemsPerRow;
        const row = Math.floor(i / itemsPerRow);
        const xPos = col * 160;
        const yPos = row * 20;

        legend.append("rect")
          .attr("x", xPos)
          .attr("y", yPos)
          .attr("width", 12)
          .attr("height", 12)
          .attr("fill", color(s.Sector));

        legend.append("text")
          .attr("x", xPos + 18)
          .attr("y", yPos + 10)
          .text(s.Sector)
          .style("font-size", "12px")
          .style("fill", "#ffffff");
      });
    }

    /*
          function renderLineChart(datosValidados) {
            const svg = d3.select("#lineChart");
            svg.selectAll("*").remove();
    
            const containerWidth = svg.node().clientWidth || 600;
            const margin = { top: 40, right: 40, bottom: 120, left: 60 };
            const width = containerWidth - margin.left - margin.right;
            const height = 450 - margin.top - margin.bottom;
    
            const g = svg
              .attr("width", width + margin.left + margin.right)
              .attr("height", height + margin.top + margin.bottom + 60)
              .append("g")
              .attr("transform", `translate(${margin.left},${margin.top})`);
    
            const tooltip = d3.select("body").append("div")
              .attr("class", "tooltip")
              .style("position", "absolute")
              .style("padding", "6px 10px")
              .style("background", "#333")
              .style("color", "#fff")
              .style("border-radius", "4px")
              .style("font-size", "12px")
              .style("pointer-events", "none")
              .style("opacity", 0);
    
            const rawSeries = [];
            datosValidados.forEach(d => {
              const baseSemana = d.Semana ?? 0;
              const sector = d.Sector ?? '';
              rawSeries.push(
                { Sector: sector, Semana: baseSemana - 4, Incremento: d.IncrementoSemana1 ?? 0 },
                { Sector: sector, Semana: baseSemana - 3, Incremento: d.IncrementoSemana2 ?? 0 },
                { Sector: sector, Semana: baseSemana - 2, Incremento: d.IncrementoSemana3 ?? 0 },
                { Sector: sector, Semana: baseSemana - 1, Incremento: d.IncrementoSemana4 ?? 0 }
              );
            });
    
            const grouped = d3.group(rawSeries, d => d.Sector);
            const series = Array.from(grouped, ([sector, values]) => {
              const uniqueByWeek = Array.from(
                d3.group(values, d => d.Semana),
                ([semana, entries]) => entries[0]
              );
              return { Sector: sector, values: uniqueByWeek.sort((a, b) => a.Semana - b.Semana) };
            });
    
            const allWeeks = [...new Set(series.flatMap(s => s.values.map(v => v.Semana)))].sort((a, b) => a - b);
            const allValues = series.flatMap(s => s.values.map(v => v.Incremento));
    
            const x = d3.scalePoint()
              .domain(allWeeks)
              .range([0, width])
              .padding(0.2); // acercar semana inicial al eje Y
    
            const y = d3.scaleLinear()
              .domain([1, d3.max(allValues)])
              .range([height, 0]);
    
            const color = d3.scaleOrdinal(d3.schemeCategory10);
    
            // Eje X con etiquetas "Semana XX"
            const xAxis = g.append("g")
              .attr("transform", `translate(0,${height})`)
              .call(d3.axisBottom(x).tickFormat(d => `Semana ${d}`).tickSize(0));
    
            xAxis.selectAll("text")
              .attr("transform", "rotate(-45)")
              .style("text-anchor", "end")
              .style("font-size", "12px")
              .style("fill", "#ffffff");
    
            xAxis.select(".domain").attr("stroke", "#ffffff");
            xAxis.selectAll(".tick line").remove(); // quitar rayitas separadoras
    
            // Eje Y sin rayitas horizontales, pero con línea vertical
            const yAxis = g.append("g")
              .call(d3.axisLeft(y).ticks(5).tickFormat(d => d === 0 ? "" : d));
    
            yAxis.selectAll(".tick line").remove(); // quitar rayitas horizontales
            yAxis.selectAll("text")
              .style("font-size", "12px")
              .style("fill", "#ffffff");
    
            yAxis.select(".domain")
              .attr("stroke", "#ffffff")
              .attr("stroke-width", 1.5);
    
            // Líneas por sector (más gruesas)
            const line = d3.line()
              .x(d => x(d.Semana))
              .y(d => y(d.Incremento));
    
            series.forEach((s, i) => {
              g.append("path")
                .datum(s.values)
                .attr("fill", "none")
                .attr("stroke", color(s.Sector))
                .attr("stroke-width", 3)
                .attr("d", line);
    
              g.selectAll(`circle.sector-${i}`)
                .data(s.values)
                .enter()
                .append("circle")
                .attr("class", `sector-${i}`)
                .attr("cx", d => x(d.Semana))
                .attr("cy", d => y(d.Incremento))
                .attr("r", 3)
                .attr("fill", color(s.Sector))
                .on("mouseover", (event, d) => {
                  tooltip.style("left", `${event.pageX + 10}px`)
                    .style("top", `${event.pageY - 20}px`)
                    .style("opacity", 1)
                    .html(`<strong>${d.Sector}</strong><br>Semana ${d.Semana}<br>Incremento: ${d.Incremento.toFixed(2)}`);
                })
                .on("mouseout", () => tooltip.style("opacity", 0));
            });
    
            // Leyenda en columnas de 3
            const legend = svg.append("g")
              .attr("transform", `translate(${margin.left},${height + margin.top + 60})`);
    
            const itemsPerRow = 3;
            series.forEach((s, i) => {
              const col = i % itemsPerRow;
              const row = Math.floor(i / itemsPerRow);
              const xPos = col * 160;
              const yPos = row * 20;
    
              legend.append("rect")
                .attr("x", xPos)
                .attr("y", yPos)
                .attr("width", 12)
                .attr("height", 12)
                .attr("fill", color(s.Sector));
    
              legend.append("text")
                .attr("x", xPos + 18)
                .attr("y", yPos + 10)
                .text(s.Sector)
                .style("font-size", "12px")
                .style("fill", "#ffffff");
            });
          }
    */
    const API_CONFIG = {
      baseUrl: 'http://172.16.11.24:2020/api',
      endpoints: {
        incrementos: '/Peso/por-sector'
      }
    };

    async function obtenerDatos() {
      try {
        const apiUrl = `${API_CONFIG.baseUrl}${API_CONFIG.endpoints.incrementos}?cedula=jordan.avellan&idSector=&semana=&IsDetalle=false`;
        const response = await fetch(apiUrl);

        if (!response.ok) {
          console.error(`Error HTTP: ${response.status} - ${response.statusText}`);
          return [];
        }

        const datos = await response.json();

        if (!Array.isArray(datos) || datos.length === 0) {
          console.warn('La respuesta del API está vacía o no es un arreglo.');
          return [];
        }


        const datosValidados = datos.map(d => ({
          Sector: d.sector || '',
          IncSemanal: d.incSemanal ?? 0,
          IncPonderado: d.incPonderado ?? 0,
          IncLineal: d.incLineal ?? 0,
          TotalIncremento: d.totalIncremento ?? 0,
          IdSector: d.idSector ?? 0,
          IncrementoSemana1: d.incrementoSemana1 ?? 0,
          IncrementoSemana2: d.incrementoSemana2 ?? 0,
          IncrementoSemana3: d.incrementoSemana3 ?? 0,
          IncrementoSemana4: d.incrementoSemana4 ?? 0,
          TipoMuestreo: d.tipoMuestreo,
          Semana: d.semana
        }));

        const semanaActual = datosValidados[0]?.Semana ?? '';
        document.querySelector("#tituloBarChart").textContent = `Incrementos por Sector de la Semana ${semanaActual}`;

        return datosValidados;
      } catch (error) {
        console.error('Error al obtener datos del API:', error);
        return [];
      }
    }

    async function obtenerDetallesPiscina(sector, semana) {
      try {

        const apiUrl = `${API_CONFIG.baseUrl}${API_CONFIG.endpoints.incrementos}?cedula=jordan.avellan&idSector=${sector}&semana=${semana}&Isdetalle=true`;
        const response = await fetch(apiUrl);

        if (!response.ok) {
          console.error(`Error HTTP: ${response.status} - ${response.statusText}`);
          return [];
        }

        const datos = await response.json();
        return Array.isArray(datos) ? datos : [];
      } catch (error) {
        console.error(`Error al obtener detalles para el sector ${sector}:`, error);
        return [];
      }
    }

    function renderizarTablaPopup(datos) {
      const container = document.getElementById('popup-table-container');
      container.innerHTML = '';

      if (!Array.isArray(datos) || datos.length === 0) {
        container.innerHTML = '<p>No hay datos disponibles para este sector.</p>';
        return;
      }

      // Actualizar título del popup con semana
      const popupTitle = document.getElementById('popup-title');
      const sector = datos[0]?.sector ?? 'Sector';
      const semana = datos[0]?.semana ?? '';
      popupTitle.textContent = `Detalles del Sector: ${sector} (Semana ${semana})`;

      // Ordenar piscinas alfanuméricamente
      datos.sort((a, b) => {
        const normalize = str => str?.toLowerCase().replace(/\s+/g, '') ?? '';
        const extractParts = str => {
          const match = normalize(str).match(/^([a-z]+)(\d+)?([a-z]*)$/i);
          return match ? [match[1], parseInt(match[2] || '0'), match[3] || ''] : [str, 0, ''];
        };

        const [textA, numA, suffixA] = extractParts(a.nombrePiscina);
        const [textB, numB, suffixB] = extractParts(b.nombrePiscina);

        if (textA !== textB) return textA.localeCompare(textB);
        if (numA !== numB) return numA - numB;
        return suffixA.localeCompare(suffixB);
      });

      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const tbody = document.createElement('tbody');

      const headers = [
        'Piscina',
        'Peso Actual',
        'Peso Anterior',
        'Incremento',
        'Fecha Muestreo',
        'Peso Siembra',
        'Días Sembrado',
        'Ha'
      ];

      const fieldMap = {
        'Piscina': 'nombrePiscina',
        'Peso Actual': 'pesoActual',
        'Peso Anterior': 'pesoAnterior',
        'Incremento': 'incremento',
        'Fecha Muestreo': 'fechaSeleccionada',
        'Peso Siembra': 'pesoSiembra',
        'Días Sembrado': 'dias',
        'Ha': 'ha'
      };

      const headerRow = document.createElement('tr');
      headers.forEach(headerText => {
        const th = document.createElement('th');
        th.textContent = headerText;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);

      datos.forEach(dato => {
        const row = document.createElement('tr');
        headers.forEach(header => {
          const field = fieldMap[header];
          let value = dato[field];

          if (field === 'fechaSeleccionada' && value) {
            const fecha = new Date(value);
            value = fecha.toLocaleDateString();
          }

          if (field === 'dias' && typeof value === 'number') {
            value = Math.round(value); // quitar decimales
          }

          if (typeof value === 'number' && field !== 'dias') {
            value = value.toFixed(2);
          }

          const cell = document.createElement('td');
          cell.textContent = value ?? '';
          row.appendChild(cell);
        });
        tbody.appendChild(row);
      });

      table.appendChild(thead);
      table.appendChild(tbody);
      container.appendChild(table);
    }

    /*
        function renderizarTablaPopup(datos) {
          const container = document.getElementById('popup-table-container');
          container.innerHTML = '';
    
          if (!datos || datos.length === 0) {
            container.innerHTML = '<p>No hay datos disponibles para este sector.</p>';
            return;
          }
    
          const table = document.createElement('table');
          const thead = document.createElement('thead');
          const tbody = document.createElement('tbody');
    
          const headers = ['Piscina', 'Peso Actual', 'Peso Anterior', 'Incremento', 'Fecha Muestreo', 'Peso Siembra', 'DiasSembrado', 'Ha'];
          const headerRow = document.createElement('tr');
          headers.forEach(headerText => {
            const th = document.createElement('th');
            th.textContent = headerText;
            headerRow.appendChild(th);
          });
          thead.appendChild(headerRow);
    
          datos.forEach(dato => {
            const row = document.createElement('tr');
            headers.forEach(header => {
              const cell = document.createElement('td');
              cell.textContent = dato[header.charAt(0).toLowerCase() + header.slice(1)] ?? '';
              row.appendChild(cell);
            });
            tbody.appendChild(row);
          });
    
          table.appendChild(thead);
          table.appendChild(tbody);
          container.appendChild(table);
        }
    */
    document.addEventListener("DOMContentLoaded", async () => {
      const datos = await obtenerDatos();
      if (datos.length === 0) {
        console.warn("No hay datos para mostrar.");
        return;
      }

      renderBarChart(datos);
      renderLineChart(datos);
      renderIncrementBarChart(datos);

      const popup = document.getElementById('popup');
      const popupClose = document.getElementById('popup-close');

      popupClose.addEventListener('click', () => {
        popup.style.display = 'none';
      });

      popup.addEventListener('click', (event) => {
        if (event.target === popup) {
          popup.style.display = 'none';
        }
      });

      const sliderWrapper = document.querySelector('.slider-wrapper');
      const slides = document.querySelectorAll('.slide');
      const totalSlides = slides.length;
      let currentIndex = 0;

      const prevButton = document.querySelector('.slider-button.prev');
      const nextButton = document.querySelector('.slider-button.next');
      const dotsContainer = document.querySelector('.pagination-dots');

      for (let i = 0; i < totalSlides; i++) {
        const dot = document.createElement('span');
        dot.classList.add('dot');
        dot.addEventListener('click', () => {
          goToSlide(i);
        });
        dotsContainer.appendChild(dot);
      }

      const dots = document.querySelectorAll('.dot');

      function goToSlide(index) {
        sliderWrapper.style.transform = `translateX(-${index * 100}%)`;
        dots.forEach((dot, i) => {
          dot.classList.toggle('active', i === index);
        });
        currentIndex = index;
      }

      prevButton.addEventListener('click', () => {
        const newIndex = (currentIndex - 1 + totalSlides) % totalSlides;
        goToSlide(newIndex);
      });

      nextButton.addEventListener('click', () => {
        const newIndex = (currentIndex + 1) % totalSlides;
        goToSlide(newIndex);
      });

      goToSlide(0);
    });
  </script>
</body>

</html>